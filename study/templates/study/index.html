{% extends 'study/main_base.html' %}

{% load htmlhelper %}

{% block title %}首页{% endblock %}
{% block titlefile %}
    <style type="text/css">
        .thumbnail {
            border: 0 none;
        }

        .col-sm-6, .col-xs-6 {
            padding: 2px 2px;
        }

        .badge {
            display: inline;
        }

        .mg-top {
            margin-top: -10px;
        }

        .mg-bottom {
            margin-bottom: 1px;
        }
    </style>
{% endblock %}
{% block content %}
    <section class="es-poster swiper-container">
        <div class="swiper-wrapper"
             style="width: 3375px; transform: translate3d(-1125px, 0px, 0px); transition-duration: 0.3s; height: 117px;">
            {% for item in abs %}
                <div class="swiper-slide" style="background: rgb(244, 244, 244); width: 375px; height: 117px;">
                    <div>
                        <a href="{{ item.url }}" target="_blank">
                            <img class="img-responsive" src="{{ item.image.url }}">
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="swiper-pager">
            {% for item in abs %}
                <span class="swiper-pagination-switch"></span>
            {% endfor %}
        </div>
    </section>

    <div id="content-container" class="container">
        <div class="row mg-top">
            {% for i in items %}
                <div class="col-sm-6 col-xs-6">
                    <div class="thumbnail mg-bottom">
                        <a href="{% url 'picture_text_paper' i.pk %}">
                            <img src="{{ i.image.url }}" alt="{{ i.name }}">
                        </a>
                        <div class="caption">
                            <a href="{% url 'picture_text_paper' i.pk %}">
                                <p style="font-size:1.2rem;color:black">{{ i.introduce|slice:'22' }}...</p>
                            </a>
                            <p style="margin-bottom:0">
                                <span class="badge" style="color:forestgreen; float:right;"><small>{% is_buy i.video.pk request.user.pk %}</small></span>
                                <span style="color:orange"><small>¥{{ i.video.price }}/{{ i.video.count }}课时</small></span>
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}


{% block scriptfile %}
    <script type="text/javascript">
        //调用微信JS api 支付
        function onBridgeReady(vid) {
            console.log('step3:' + vid);
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                {
                    appId: "{{ params.appid }}",        //公众号名称，由商户传入
                    timeStamp: "{{ params.timeStamp }}", //时间戳，自1970年以来的秒数
                    nonceStr: "{{ params.nonceStr }}",  //随机串
                    package: "prepay_id={{ params.prepay_id }}",  //预支付id
                    signType: "MD5",  //微信签名方式
                    paySign: "{{ params.sign }}"     //微信签名
                },
                function (res) {
                    //支付成功后返回 get_brand_wcpay_request:ok
                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                        // 跳转到支付成功的页面
                        //window.location.href = '#';
                        alert('支付成功');
                        $.get("{% url 'buyvideocurriculum' %}", {'pk': vid}, function (ret) {
                            if (ret == "1")
                                location.reload();
                            else
                                alert('保存支付记录失败')
                        })
                    } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
                        alert("您已取消支付!");
                        {#alert({{ params.machine_code }});#}
                        {#window.location.href = '';#}
                    } else if (res.err_msg == "get_brand_wcpay_request:fail") {
                        $.each(res, function (key, value) {
                            alert(value);
                        });
                        alert("支付失败!");
                    }
                }
            );
        }

        function callpay(vid) {
            console.log('step1:' + vid);
            if (typeof WeixinJSBridge == "undefined") {
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            } else {
                $.get('{% url 'weixinpay' %}', {vid: vid}, function (data) {
                    console.log('retval:' + data);
                    onBridgeReady(vid);
                })
                console.log('step2:' + vid);
            }
        }
    </script>
{% endblock %}