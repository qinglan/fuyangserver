!function(e){function t(e){e=e||window.location.href;var t=e.substring(e.lastIndexOf("?")+1);t.lastIndexOf("#")>=0&&(t=t.substring(0,t.lastIndexOf("#")));for(var a=t.split("&"),n={},i=0;i<a.length;i++){var o=a[i],l=o.substring(0,o.indexOf("=")),r=o.substring(o.indexOf("=")+1);/^-?(\d+)(\.\d+)?$/.test(r)?n[l]=Number(r):"true"===r?n[l]=!0:"false"===r?n[l]=!1:n[l]=r}return n}var a,n,i,o,l,r,c=40,d=navigator.userAgent.indexOf("Mobile")>=0,s=d?1:3,b="",u='<li><div class="bubble-box" id="bubble-box"> <div class="bubble-header" id="bubble-header"><img src="{0}" /></div><div class="bubble-content" id="bubble-content" style="{1}" ><span class="bubble-custom-name">{2}</span><span class="bubble-req-time">{3}</span><p  style="max-height:77px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;margin-top:10px;margin-bottom:5px;">{4}</p></div></div></li>',g={},f=t()||{};!function(e){switch(e){case"en":g={L0001:"today",L0002:"yestoday",L0003:"[photo]",L0004:"[voice]",L0005:"[send a message to you]"};break;default:g={L0001:"今天",L0002:"昨天",L0003:"[图片]",L0004:"[语音]",L0005:"[给您发送了一条新消息]"}}}(f.lan);var p=function(e,t,a){e.addEventListener?e.addEventListener(t,a,!0):e.attachEvent("on"+t,a)},w=function(e,t){var a=/\{\d+\}/g,n=0;return a.test(e)&&"[object Array]"===Object.prototype.toString.call(t)?e.replace(a,function(){var e=t[n++];return e}):e},h=function(e,t){var a,n=new Date(t);if(t){var i=new Date,o=Math.abs(i.getDate()-n.getDate()),l=n.getHours()>9?n.getHours():"0"+n.getHours(),r=n.getMinutes()>9?n.getMinutes():"0"+n.getMinutes(),c=n.getFullYear();switch(o){case 0:a=w("{0} {1}:{2}",[g.L0001,l,r]);break;case 1:a=w("{0} {1}:{2}",[g.L0002,l,r]);break;default:a=w("{0} {1}:{2}",[c,l,r])}}return a},m=function(){i=document.getElementById("clearBtn"),l=document.getElementById("bubble-wrap"),o=document.getElementById("wapClearBtn")},y=function(){var e=document.getElementById("bubble-wrap"),t=e.getElementsByTagName("li");if(t&&t.length>0){d&&(document.getElementById("wapClearBtn").style.display="block");for(var i=0;i<t.length;i++)t[i].style.height=t[i].childNodes[0].offsetHeight+"px";switch(i){case 1:n=20;break;case 2:n=40;break;case 3:n=60;break;default:n=0}a=d?document.getElementById("bubble-wrap").offsetHeight+n+"px":document.getElementById("bubble-wrap").offsetHeight+n+c+"px"}else a=0;window!==window.parent&&window.parent.postMessage(JSON.stringify({type:"bubble.frameHeight",data:a}),"*")},v=function(e){var t="";e=e.childNodes||e;for(var a=0;a<e.length;a++)t+=1!=e[a].nodeType?e[a].nodeValue:v(e[a].childNodes);return t},x=function(e){var t=e;return e.indexOf("webchat_img_upload")>=0?t=g.L0003:e.indexOf("webchat_voice_upload")>=0?t=g.L0004:(e.indexOf("/>")>=0||e.indexOf("</")>=0)&&(t=g.L0005),r||(r=document.createElement("div")),r.innerHTML=t,t=v(r)},O=function(e){window.parent!==window&&parent.postMessage(JSON.stringify({type:"bubble.customBtn",data:e}),"*"),e.content=x(e.content);var t=document.createElement("div"),a="";d&&(a="width:70%;max-width:70%;"),t.innerHTML=w(u,[e.header,a,e.name,h(+new Date,e.t),e.content]);var n=t.getElementsByTagName("li")[0],i=l.children;if(i&&i.length>=s&&(l.removeChild(l.children[0]),d))for(var o=0;o<i.length;o++)l.removeChild(l.children[0]);l.appendChild(n);try{var r=n.childNodes[0].childNodes[2];p(r,"click",S)}catch(c){}N.set(e),y()},S=function(){window!==window.parent&&window.parent.postMessage(JSON.stringify({type:"bubble.clickMsg"}),"*")},N={set:function(e){if(window.localStorage){var t=window.localStorage.getItem("bubbleData");t=JSON.parse(t||"{}")||{},t[b]=t[b]||[],t[b]&&t[b].length>=s&&t[b].shift(0),d&&(t[b]=[]),t[b].push(e),t=JSON.stringify(t);try{window.localStorage.setItem("bubbleData",t)}catch(a){}}},get:function(e){if(window.localStorage){var t=window.localStorage.getItem(e);if("string"==typeof t)try{t=JSON.parse(t)||[]}catch(a){}else"object"==typeof t&&(t=t||[]);for(var n=t[b]||[],i=0;i<n.length;i++){var o=document.createElement("div"),r="";d&&(r="width:70%;max-width:70%;"),o.innerHTML=w(u,[n[i].header,r,n[i].name,h(+new Date,n[i].t),n[i].content]);var c=o.getElementsByTagName("li")[0];l.appendChild(c);try{var s=c.childNodes[0].childNodes[2];p(s,"click",S)}catch(a){}y()}}}},B=!0,L=function(e){var t=[];if("string"==typeof e.data)try{t=JSON.parse(e.data)}catch(a){}else"object"==typeof e.data&&(t=e.data);switch(t.data&&t.data.uid&&B&&(b=t.data.uid,N.get("bubbleData"),B=!1),t.type){case"bubble.onDefalutMsg":y();break;case"bubble.reviceMsg":O(t.data);break;case"bubble.expand":M()}},k=function(){if(window.localStorage){var e=window.localStorage.getItem("bubbleData");e=JSON.parse(e||"{}"),e[b]=e[b]||[],e&&e[b].length>0&&(clearBtn.style.filter="Alpha(Opacity=100)",clearBtn.style.opacity="1")}},I=function(){if(window.localStorage){var e=window.localStorage.getItem("bubbleData");e=JSON.parse(e||"{}"),e[b]=e[b]||[],e&&e[b].length>0&&(clearBtn.style.filter="Alpha(Opacity=0)",clearBtn.style.opacity="0")}},D=function(){clearBtn.style.backgroundPosition="0 -272px"},E=function(){clearBtn.style.backgroundPosition="0 -170px"},M=function(){if(window.localStorage){try{var e=window.localStorage.getItem("bubbleData");e=JSON.parse(e),e[b]=[],e=JSON.stringify(e),window.localStorage.setItem("bubbleData",e)}catch(t){}N.get("bubbleData");var a=l.children.length;if(a>0){for(var n=0;n<a;n++)l.removeChild(l.children[0]);y()}}window!==window.parent&&window.parent.postMessage(JSON.stringify({type:"bubble.removeAll"}),"*")},J=function(){p(window,"message",L),p(document,"mouseover",k),p(document,"mouseleave",I),p(i,"mouseenter",D),p(i,"mouseleave",E),p(i,"click",M),p(o,"click",M)},H=function(){if(N.get("bubbleData"),d){i.style.display="none";var e=document.body.offsetWidth;e>=300&&e<340?o.style.right="8px":e>=340&&e<360?o.style.right="22px":e>=360&&(o.style.right="33px")}else o.style.display="none"},C=function(){m(),J(),H()};C()}();